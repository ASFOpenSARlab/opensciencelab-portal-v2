---
name: Deploy CDK
on: # yamllint disable-line rule:truthy
  workflow_dispatch: {}
  push:
    paths:
      - "build/cdk.*"
      - "portal-cdk/*"
      # Or changes to this action:
      - .github/workflows/deploy-cdk-app.yaml
    branches:
      - "*/*"
      - main
    tags:
      - "v*.*.*"
env:
  cdk_image: ghcr.io/asfopensarlab/cdk-env
jobs:
  setup:
    uses: ASFOpenSARlab/osl-utils/.github/workflows/reusable-setup-env.yaml@v0.0.9
    with:
      tagname: ${{ inputs.tagname || github.ref_name }}
  wait-for-cdk-image:
    # Because the image may not ready yet, lets wait for it
    needs:
      - setup
    uses: ./.github/workflows/reusable-image-readiness-wait.yaml
    with:
      image_name: "asfopensarlab/cdk-env"
      image_tag: ${{ needs.setup.outputs.branchtag }}
      repo_username: ${{ github.repository_owner }}
    secrets:
      repo_password: ${{ secrets.GITHUB_TOKEN }}
  use-cdk-image:
    environment: ${{ needs.setup.outputs.environment }}
    env:
      image-tag: ${{ needs.setup.outputs.branchtag }}
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.wait-for-cdk-image.outputs.image_uri }}
    needs:
      - setup
      - wait-for-cdk-image
    permissions:
      id-token: write
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{vars.AWS_ACCOUNT_NUMBER}}:role/deploy_portal_stack_role
          aws-region: ${{vars.AWS_DEFAULT_REGION}}
      - name: CDK Helloworld
        id: hello-wold
        run: |-
          echo "container.image was ${{ needs.wait-for-cdk-image.outputs.image_uri }}"
          echo "Hello from inside CDK (${{ env.image-tag }})"
          aws s3 ls
          cdk --version
